---
title: "Grand débat national - tableau de bord"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    social: menu
    source_code: embed
    vertical_layout: fill
runtime: shiny
---
# TODO Ajouter les contributions disponibles ici : https://granddebat.fr/pages/donnees-ouvertes


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(shinydashboard)
library(flexdashboard)
library(knitr)
library(dplyr)
library(ggplot2)
library(Rpdb)

# Pour les graphiques "sympas"
library(htmltools)
library(htmlwidgets)
library(metricsgraphics)
library(RColorBrewer)
library(plotly)
library(DT)
library(SnowballC)
library(wordcloud)
library(leaflet)

# Chargement des données
filecache <- "cache/listevt.Rdata"
timeout_cache <- 90 # durée de vie du fichier dans le cache

if(file.exists(filecache) & difftime(Sys.time(),file.info(filecache)$mtime) < 1/24/60*timeout_cache){
  load(filecache) 
}
else{
  source("readdata.R")

}

weekDaysOrder = c("lundi", "mardi", "mercredi", "jeudi", "vendredi", "samedi", "dimanche")

```

Synthèse
=======================================================================

Row
-----------------------------------------------------------------------

### événements depuis le 1er janvier

```{r}
#count <- rparsed$data$events$totalCount
valueBox(totalcount, icon="fa-calendar")
```

### événements par jour

```{r}
count <- round(totalcount / listevt %>% count (startAt) %>% nrow(), digits = 0)
valueBox(count, icon="fa-comments")
```

### événements à venir

```{r}
dt <- filter(listevt, startAt >= format(Sys.time(),"%Y-%m-%d"))
count <- dt %>% nrow()
valueBox(count, icon="fa-landmark")
```

### est la ville la plus impliquée

```{r}
dtcity <- listevt %>% count (Commune) %>% arrange(desc(n))
dtcity <- filter(dtcity, !is.na(Commune))
count <- dtcity$Commune [1]
valueBox(count, icon="fa-landmark")
```


Row
-----------------------------------------------------------------------

### Création d'événements par jour

```{r histo_createAt, echo=FALSE}
dt <- listevt %>% count (createdAt)
dt %>%
  mjs_plot(x=createdAt, y=n, width=600, height=400) %>%
  mjs_axis_x(xax_format="date") %>% 
  mjs_line(area=TRUE)
```

### Création d'événements par heure toutes journées confondues

```{r histo_hours, echo=FALSE}
dt <- as.numeric(format(strptime(listevt$node.createdAt, format="%Y-%m-%d %H:%M:%S"), "%H"))
mjs_plot(dt, width=500, height=400) %>%
  mjs_histogram(bar_margin=2) %>%
  mjs_labs(x_label="Heure",y_label="Nombre d'événements")
```



Row
-----------------------------------------------------------------------
### Répartition des événements entre début janvier et fin avril

```{r histo_startAt, echo=FALSE}
dt <- filter(listevt, startAt >="2019-01-10" & startAt <="2019-04-30")
dt <- dt %>% count (startAt)
dt %>%
  mjs_plot(x=startAt, y=n, width=600, height=400) %>%
  mjs_axis_x(xax_format="date") %>% 
  mjs_line(area=TRUE)
```


### Programmation des événements en fonction des jours de la semaine

```{r histo_weekdays, echo=FALSE}
dt <- listevt %>% count (weekDay)
plot_ly(dt, x=~weekDay, y=~n) %>% 
  layout(yaxis = list(title="Nombre d'événements"), xaxis = list(title=""))
```

Détails par commune
=======================================================================

Row
-----------------------------------------------------------------------
### Liste des communes participants

```{r dtcity, echo=FALSE}

map_data = listevt[,c("node.lat", "node.lng")]
DT_data = listevt %>% group_by_(COMMUNE) %>% count(name = "Nombre d'évènements")

leaflet() %>%
  addTiles() %>%
  addMarkers(data = map_data, lat = ~node.lat, lng = ~node.lng, clusterOptions = markerClusterOptions(), 
             label = mytext)

DT::datatable(DT_data)

```


Nuage de mots
=======================================================================

Row
-----------------------------------------------------------------------
### Mots les plus présents dans les titres des événements

```{r wordcloud, echo=FALSE}
set.seed(1234)
wordcloud(words = dfmots$word, freq = dfmots$freq, min.freq = 1,
          max.words=200, random.order=FALSE, rot.per=0.35, 
          colors=brewer.pal(8, "Accent"))

# plot_ly(data = dfmots[1:20,], x = ~word, y = ~freq) %>%
#   layout(yaxis = list(title = 'Fréquence d\'utilisation du mot'), xaxis = list(title = 'Mot'))

kableExtra::kable(x = dfmots[order(dfmots$freq)>10,])
```


Crédits
=======================================================================

### Données
```{r , echo=FALSE}
file.info(filecache)$mtime
```

### Quelques remerciements

- Christophe B. pour son aide sur [GraphQL](https://graphql.org/).
- Les développeurs des packages [htmlwidgets](https://www.htmlwidgets.org/) et [metricsgraphics](https://metricsgraphicsjs.org/).
